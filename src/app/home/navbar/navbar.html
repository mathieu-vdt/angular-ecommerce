<p-toolbar class="fixed top-0 left-0 right-0 z-50"
  [style]="{
    'background': '#ffffff',
    'box-shadow': '0 2px 6px rgba(0,0,0,.06)',
    'border': 'none',
    'border-radius': '0',
    'padding': '1rem 2rem',
  }"
>
  <div class="p-toolbar-group-start flex items-center gap-2">
    <!-- Logo -->
    <a routerLink="/" class="flex items-center font-bold text-xl gap-2">
      <img src="assets/logoMathieu_black.png" alt="Logo" class="h-8" />
    </a>
  </div>

  <div class="hidden lg:flex p-toolbar-group-center flex-1 justify-center">
    <ul class="flex gap-8">
      <li *ngFor="let l of links"
          routerLinkActive='is-active'
          [routerLinkActiveOptions]="{ exact: l.routerLink === '/' }">
        <a
          [routerLink]="l.routerLink"
          class="nav-link relative font-semibold flex items-center gap-2
                after:block after:h-[2px] after:w-0 after:bg-current after:transition-all after:duration-200
                after:absolute after:left-1/2 after:-translate-x-1/2 after:-bottom-1
                hover:after:w-full focus-visible:after:w-full"
          [ngClass]="'text-[#262626] hover:text-sky-600'"
        >
          <i [class]="l.icon"></i>
          {{ l.label }}
        </a>
      </li>
    </ul>
  </div>


  <!-- Actions DROITE (desktop) + burger mobile -->
<div class="p-toolbar-group-end flex items-center gap-3">
  <!-- Actions desktop uniquement -->
  <div class="hidden lg:flex items-center gap-3">
    <ng-container *ngIf="isLoggedIn; else loggedOut">
        <div class="relative">
          <button type="button"
                  class="inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-gray-50 transition"
                  (click)="accountPop.toggle($event)"
                  aria-label="Account">
            <p-avatar
              *ngIf="user?.avatarUrl; else initAvatar"
              [image]="user!.avatarUrl"
              shape="circle"
            ></p-avatar>
            <ng-template #initAvatar>
              <p-avatar [label]="initials" shape="circle" styleClass="bg-sky-600 text-white"></p-avatar>
            </ng-template>
            <span class="font-semibold text-[#262626] max-w-[160px] truncate">{{ displayName }}</span>
            <i class="pi pi-angle-down text-[#262626]"></i>
          </button>

          <p-popover #accountPop>
            <ng-template pTemplate="content">
              <div class="min-w-[220px]">
                <div class="flex items-center gap-3 p-3 border-b">
                  <p-avatar [label]="initials" shape="circle" styleClass="bg-sky-600 text-white"></p-avatar>
                  <div class="min-w-0">
                    <div class="font-semibold truncate">{{ displayName }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ user?.email }}</div>
                  </div>
                </div>
                <nav class="py-1">
                  <a *ngIf="isAdmin" routerLink="/admin"
                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 rounded transition">
                    <i class="pi pi-shield"></i>
                    <span>Admin</span>
                  </a>
                  <button class="w-full text-left flex items-center gap-2 px-3 py-2 hover:bg-gray-50 rounded transition"
                          (click)="logout(); accountPop.hide()">
                    <i class="pi pi-sign-out"></i>
                    <span>Logout</span>
                  </button>
                </nav>
              </div>
            </ng-template>
          </p-popover>
        </div>
      </ng-container>

    <ng-template #loggedOut>
      <!-- Log in (texte) -->
      <a
        routerLink="/login"
        class="group relative flex items-center gap-2 font-medium 
              after:block after:h-[2px] after:w-0 after:bg-current after:transition-all after:duration-200 after:absolute after:left-1/2 after:-translate-x-1/2 after:-bottom-1
              hover:after:w-full focus-visible:after:w-full"
        [ngClass]="'text-[#262626] hover:text-sky-600'"
      >
        <i class="pi pi-sign-in"></i>
        Log in
      </a>


      <!-- Sign In (outlined) : blanc sur home -->
      <a
        routerLink="/register"
        pButton
      >
        <i class="pi pi-user-plus mr-2"></i>
        Sign In
      </a>
    </ng-template>

    <!-- Panier (badge + popover au clic ou au survol) -->
    <div class="relative  lg:block">
      <p-overlaybadge [value]="(count$ | async) || 0" >
        <button
                class="text-[#262626] hover:text-sky-600 transition text-xl"
                type="button"
                (click)="cartPopover.toggle($event)"
                aria-label="Cart">
          <i class="pi pi-shopping-cart" style="font-size: 1.2rem"></i>
        </button>
      </p-overlaybadge>

      <p-popover #cartPopover>
        <ng-template pTemplate="content">
          <ng-container *ngIf="(items$ | async) as items; else emptyCart">
            <div class="min-w-[280px] max-w-[360px]">
              <div class="max-h-64 overflow-auto divide-y">
                <div *ngFor="let it of items" class="flex items-center gap-3 p-2">
                  <img [src]="it.product.image_url || 'assets/placeholder.png'"
                      class="w-10 h-10 rounded object-cover" />
                  <div class="flex-1">
                    <div class="text-sm font-medium max-w-[150px] truncate">{{ it.product.name }}</div>
                    <div class="text-xs text-gray-500">
                      x{{ it.qty }} â€” ${{ it.product.price }}
                    </div>
                  </div>
                  <button pButton class="p-button-text p-0"
                          (click)="removeFromCart(it.product.id!)"
                          aria-label="Remove">
                    <i class="pi pi-times"></i>
                  </button>
                </div>
              </div>
              <div class="flex items-center justify-between p-2 font-semibold">
                <span>Total</span>
                <span>${{ (cart.total$ | async) || 0 | number:'1.0-2' }}</span>
              </div>
              <div class="flex gap-2 p-2">
                <a routerLink="/cart" pButton class="p-button-outlined w-full">View cart</a>
                <a routerLink="/cart" pButton class="w-full">Checkout</a>
              </div>
            </div>
          </ng-container>

          <ng-template #emptyCart>
            <div class="p-4 text-sm text-gray-500">Your cart is empty.</div>
          </ng-template>
        </ng-template>
      </p-popover>
    </div>
  </div>

  <!-- Burger mobile uniquement -->
  <div class="lg:hidden">
    <button
  pButton
  class="p-button-text lg:hidden"
  type="button"
  (click)="sidebarVisible = true"
  [ngStyle]="{ color: '#262626' }"
  aria-label="Menu"
>
  <i class="pi pi-bars text-xl"></i>
</button>

  </div>
</div>

</p-toolbar>
<div class="h-20 lg:h-18"></div>

<!-- SIDEBAR MOBILE -->
<p-drawer [(visible)]="sidebarVisible" position="left" [modal]="true" [dismissible]="true" [showCloseIcon]="true">
  <div class="flex flex-col gap-6">
    <!-- Liens -->
    <nav>
      <ul class="flex flex-col gap-4">
        <li *ngFor="let l of links">
          <a
            [routerLink]="l.routerLink"
            routerLinkActive="active-link"
            class="group flex items-center gap-2 relative font-semibold
                  after:block after:h-[2px] after:w-0 after:bg-current after:transition-all after:duration-200 after:absolute after:left-1/2 after:-translate-x-1/2 after:-bottom-1
                  hover:after:w-full focus-visible:after:w-full"
          >
            <i [class]="l.icon"></i>
            {{ l.label }}
          </a>

        </li>
       <a [routerLink]="'/cart'"
        class="group flex items-center gap-2 relative font-semibold
                after:block after:h-[2px] after:w-0 after:bg-current after:transition-all after:duration-200
                after:absolute after:left-1/2 after:-translate-x-1/2 after:-bottom-1
                hover:after:w-full focus-visible:after:w-full text-[#262626] hover:text-sky-600">
        <span class="inline-flex relative">
          <p-overlaybadge [value]="(count$ | async) || 0" class="inline-flex">
            <i class="pi pi-shopping-cart text-base"></i>
          </p-overlaybadge>
        </span>
        Cart
      </a>

      </ul>
    </nav>

    <hr class="border-surface-200" />

    <div class="flex flex-col gap-3">
      <ng-container *ngIf="isLoggedIn; else loggedOut">
        <div class="relative">
          <button type="button"
                  class="inline-flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-gray-50 transition"
                  (click)="accountPop.toggle($event)"
                  aria-label="Account">
            <p-avatar
              *ngIf="user?.avatarUrl; else initAvatar"
              [image]="user!.avatarUrl"
              shape="circle"
            ></p-avatar>
            <ng-template #initAvatar>
              <p-avatar [label]="initials" shape="circle" styleClass="bg-sky-600 text-white"></p-avatar>
            </ng-template>
            <span class="font-semibold text-[#262626] max-w-[160px] truncate">{{ displayName }}</span>
            <i class="pi pi-angle-down text-[#262626]"></i>
          </button>

          <p-popover #accountPop>
            <ng-template pTemplate="content">
              <div class="min-w-[220px]">
                <div class="flex items-center gap-3 p-3 border-b">
                  <p-avatar [label]="initials" shape="circle" styleClass="bg-sky-600 text-white"></p-avatar>
                  <div class="min-w-0">
                    <div class="font-semibold truncate">{{ displayName }}</div>
                    <div class="text-xs text-gray-500 truncate">{{ user?.email }}</div>
                  </div>
                </div>
                <nav class="py-1">
                  <a *ngIf="isAdmin" routerLink="/admin"
                    class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 rounded transition">
                    <i class="pi pi-shield"></i>
                    <span>Admin</span>
                  </a>
                  <button class="w-full text-left flex items-center gap-2 px-3 py-2 hover:bg-gray-50 rounded transition"
                          (click)="logout(); accountPop.hide()">
                    <i class="pi pi-sign-out"></i>
                    <span>Logout</span>
                  </button>
                </nav>
              </div>
            </ng-template>
          </p-popover>
        </div>
      </ng-container>
      <ng-template #loggedOutM>
        <a routerLink="/login" pButton class="p-button-text w-full" (click)="sidebarVisible = false">
          <i class="pi pi-sign-in mr-2"></i> Log in
        </a>
        <a routerLink="/register" pButton class="p-button-outlined w-full" (click)="sidebarVisible = false">
          <i class="pi pi-user-plus mr-2"></i> Sign In
        </a>
      </ng-template>
    </div>
    

  </div>
</p-drawer>